# Lab4 : セルフBIツール（Oracle Analytics Cloud ：OAC）を用いたデータアクセス・分析

## コンテンツ

- セルフBIツール（OAC）からデータレイク環境への接続
- OAC上で平日／休日、天気による利用状況の変化を確認



### セルフBIツール（OAC）からデータレイク環境への接続

セルフBIツール（OAC）を用いてデータ分析を実施するためにOACからデータレイクにアクセスする準備をします。

- データレイクに接続するための情報の確認
- ネットワーク設定（FireWall設定）の変更
- OACのデータ接続設定

データレイクに接続するための情報を確認します。

（SSHポートを使う場合：Linux/Macの例）

```
ssh -L  8080:localhost:8080 opc@hoge
```

#### データレイクに接続するための情報の確認

1.データレイク（Hadoop/Spark）環境の管理ツール（Ambari）にアクセスします。
`Ambariへのアクセス ： https://localhost:8080`

![](https://camo.githubusercontent.com/797d8a4b3d9bad6012c969fdf41c0fc7465d764d/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f30306333303738382d323737372d346464652d383636652d6161346564653965353838642f623539373666393064393563313837332f7265732f32633362653233622d653236322d346266342d383465652d6532333637326465666264332f736b697463682e706e67)

2.モードの変更およびPortの確認

![](https://camo.githubusercontent.com/2bd2983710a2e47acffd4d95b5e2663a38ed5be4/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f66343266666362352d316164322d343638622d396461372d6436643039613462613537372f386432613763626262623466356663332f7265732f35363132386433302d313435392d346433312d396538382d3634393437383565653535332f736b697463682e706e67)

3.Custom spark2-thrift-sparkconf」セクションにて以下を制定します。 

![](https://camo.githubusercontent.com/8a3e9d25344810356f58648808fbee26b4fb62b2/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f66303666353830372d306334622d346538372d623730322d3964303032623164383936392f646133336565373233393736363531662f7265732f39316231336538382d383136652d346561392d396361322d3534333331353765656431302f736b697463682e706e67)

![](https://camo.githubusercontent.com/8024d20fff8e036556723b08250a0ae33d4439e0/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f63306139636532632d376632302d346666652d623232652d3031653237356430646662332f316232386166366331343339646638342f7265732f64383830376133642d346337392d343535342d616637622d6232353263643630343864352f736b697463682e706e67)


4.メモリの設定

・spark_daemon_memoryを4192に設定
・content内にある[SPARK_EXECUTOR_MEMORY="4G"]に設定＆コメントを外す

![](https://camo.githubusercontent.com/0f55b4f3a9ed4c5799f09a50772531112df9e94c/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f39366435353062372d323830652d343439362d383333312d3663646264393131613230312f373039373266303930313836643939622f7265732f38613231373065322d336166342d343238312d623535382d3661393361373366643831382f736b697463682e706e67)

５．設定を保存して「Restart All」でサービスを再起動


#### ネットワーク設定（FireWall設定）の変更

OCI（Oracle Cloud Infrastracture）の設定画面からネットワークのFirewall設定を変更します。

該当するVCN/Subnetに関連するSecurity Lists接続情報にSpark Thrift接続に必要な設定（Ingree: TCPポート 10016の許可）を追加します。

![](https://camo.githubusercontent.com/e9278e26c0e74665e07eefcb3b861df6ca192b5f/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f38313533336232642d303733652d343330322d613835392d3765353538616436396465382f353665336361373462353766306332302f7265732f39383435663338372d633937652d343664332d393366372d3134396266643130343063372f736b697463682e706e67)

![](https://camo.githubusercontent.com/8f185fb32f68bef8ec0df268b6c4f7d2d4ee55f9/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f31633135363564322d663661342d343965332d613461372d6562383537323833653731642f633136333939653166623964616562332f7265732f36373037653863352d393331642d346633392d616631342d3636636632373130363334332f736b697463682e706e67)

※ Destination port rangeには、hive.server2.thrift.portの値を設定する（上記は10016を使用しているときの例）



#### OACのデータ接続設定

OACにログイン後、ホーム画面の右上にある「create」ボタンをクリックします。

![](https://camo.githubusercontent.com/dfa576aedc71585c263f7d584692b647a91934cd/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f65626231353362362d616532622d343537302d386164312d6639346663303437383436382f633035663138353737336236303865612f7265732f65643263333462382d353332322d343265662d623864392d6262383264376363623732362f736b697463682e706e67)


「Create Data Set」画面の右上にある「Create Connection」をクリックします。

![](https://camo.githubusercontent.com/da3bd4cde09a6b48199e4d1cef82888a85490d1b/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f32363363383864632d326234392d343161662d623132322d6436366330306133393532642f303337396636646331333338616430372f7265732f61323430646264332d636631362d343838652d626335662d3331646462636263323261302f736b697463682e706e67)

「Create Connection」画面の下の方にある「Spark」をクリックします。

![](https://camo.githubusercontent.com/4e85aa143902d60e1e2e6f18a63e778295ce18e4/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f34616364636362612d383563332d343639622d393134642d3732633362633132653565362f393536653236376663373634636262642f7265732f63383563623761312d316632322d343264662d623861322d6632313661326361353939622f736b697463682e706e67)



「Create Connection」画面のホスト、ポートを環境に合わせて設定します。

![](https://camo.githubusercontent.com/df5de0704038c4fe0bceddac5fae8e8a7f6b1ef0/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f61356132343866322d333235322d346333622d613537652d6430616235303436633565392f653231626236663234353636643962382f7265732f39303364626565622d396531312d343032312d383036362d6332613435353966333264362f736b697463682e706e67)



上記でConnection情報が登録されます。

引き続き、分析に用いるテーブル（bike_trips_weather_parquet）を選択します。



![](https://camo.githubusercontent.com/8cf3aec69b32ca976f2f0cc5c069a37c36e64961/68747470733a2f2f7777772e657665726e6f74652e636f6d2f73686172642f7336322f73682f63373130646638322d323233372d343530392d386334302d6335356431343837333661642f346139656431626438623461636137372f7265732f31396331326666312d383963612d346633342d396565332d3963376435323837666436302f736b697463682e706e67)



※ 以降は、Notebookの「Journeys/New Data Lake/Tutorial 4c」の内容に沿って操作します。


--- Data件数を少なくするための処理（環境に応じて実施）

```
create table bike_trips_weather_parquet_small
stored as parquet
as select * from bike_trips_weather_parquet
limit 500000
```


### OAC上で平日／休日、天気による利用状況の変化を確認

- Trips per hourのVisualization
- Trips per hour based on workdaysのVisualization
- Trips per hour based on workdays and weatherのVisualization


